<!DOCTYPE html>
<html>
<!-- Created with help from Prof. Andrews' code,
     especially code on tooltips and configurable scatterplot. -->
  <head>
    <meta charset="utf-8">
    <title>Emily and Jamie Final Project</title>
      <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
      <style type="text/css">
      h1{
        margin:0px;
        font-family:sans-serif;
        font-size:24px;
        text-align:center;
      }

      h2{
        margin:0px;
        font-family:sans-serif;
        font-size:18px;
        text-align:center;
      }
      .axis text{
          font-family:sans-serif;
          font-size:11px;
      }
      .axis path,
      .axis line{
        fill:none;
        stroke:gray;
        shape-rendering: crisp-edges;
      }

      .collegeListElement {
        margin: 0;
      }

      /* css for putting two divs side by side */
      #container {
          margin: auto;
      }
      #visDiv {
          float: left;
      }
      #legend {
          width:145px;
          height:210px;
          float:left;
          margin:3em;
          padding:1em;
          border:5px solid black;
      }
      #legend p{
          font-family:sans-serif;
          font-size:16px;
          font-weight:bold;
      }

      #legend h3{
        margin:3px;
        font-family:sans-serif;
        font-size:18px;
        text-align:center;
      }

      #clear {
          clear: both;
      }

</style>
  </head>
  <body>
    <h1>Main Vis</h1>
    <h2>by Emily Sarich and Jamie Hand</h2>
    <div id="container">
        <div id="visDiv"></div>
        <div id="legend">
            <p>
                <h3>Ethnic Category</h3>
                <p id="collegeList"></p>
            </p>
        </div>
        <div id="clear"></div>
        <p>Year: <select id="yearSelect"><optgroup label="Metrics" id="yearmetrics"></optgroup></select></p>
    </div>

    <script>


      var yearData = "2005";

      var createVis = function(data){
          /* vis properties */
          width = 700;
          height = 500;


          /* remove unwanted ethnic categories */
          // var yearData;
          var unwanted_cats = ["total", "white_nonhispanic", "white"];
          data = data.filter(function(d){
              if(unwanted_cats.indexOf(d.ethnic_cat) != -1){
                  return false;
              }
              return true;
          });

          /* nest data */
          var nested = d3.nest()
                         .key(function(d){return d.year;})
                         .key(function(d){return d.ethnic_cat;})
                         .rollup(function(array){
                           return array.map(function(object){
                             return {
                               x: object.college,
                               y: +object.num_firstyears
                             };
                           });
                         })
                         .entries(data);

          console.log("HELLOOOOO nested");
          console.log(nested);



          /* populate year menu */
          var yearMenu = d3.select("#yearmetrics");
          nested.forEach(function(obj){
            yearMenu.append("option").attr("value", obj.key).text(obj.key);
          })
          // // for (prop in nested){
          // //   console.log("prop!!!!!!!!");
          // //   console.log(prop);
          // //   yearMenu.append("option").attr("value", prop).text(prop);
          // // }
          //
          /* start with default value of 2005 */
          // document.getElementById('yearSelect').value = "2005";

          d3.select("#yearSelect").on("change", function(){
            createVis.setYear(this.value);
            createVis(data);
          });



          /* make a machine that does the stacking */
          // stack an array of objects, with x = 2005, y = num_firstyears, y0 = i
          var stack = d3.layout.stack()
                               .values(function(d){
                                 return d.values;
                               });

          /* actually stack the data */
          console.log(nested);
          console.log(yearData);
          console.log(nested.indexOf(yearData));
          var stackedData = stack(nested.find(yearData).values);

          var margin = {top: 20, right: 50, bottom: 40, left: 30};
            //   width = 500 - margin.left - margin.right,
            //   height = 500 - margin.top - margin.bottom;

          /* make x and y scales */
          var x = d3.scale.ordinal().rangeRoundBands([0, width]);
          var y = d3.scale.linear().rangeRound([height, 0]);
          var color = d3.scale.category10();
          // var colorValue = function(d) {
          //     return d.ethnic_cat;
          // };

          var svg = d3.select("#visDiv").append("svg")
                      .attr("width", width + margin.left + margin.right)
                      .attr("height", height + margin.top + margin.bottom)

          var chart = svg.append("g")
                      .attr("transform", "translate("+margin.left+","+margin.top+")");

          var xAxisG = chart.append("g")
                        .attr({
                            "class": "axis",
                            "transform": "translate(0,"+height+")"
                        });
          var xAxis = d3.svg.axis()
                        .scale(x)
                        .orient("bottom");
          var xAxisTitle = xAxisG.append("text")
                                 .attr({
                                     "x":width/2,
                                     "y":(margin.bottom),
                                     "text-anchor":"middle"
                                 })
                                 .text("College");

          var yAxisG = chart.append("g")
                        .attr({
                            "class": "axis"
                        });
          var yAxis = d3.svg.axis()
                        .scale(y)
                        .orient("left");
          var yAxisTitle = yAxisG.append("text")
                                 .attr({
                                     "x":-width/2,
                                     "y":1/2 * -margin.left,
                                     "text-anchor":"middle",
                                     "transform":"rotate(-90)"
                                 })
                                 .text("Number of First Year Students Entering in " + yearData);
                                 // TODO include the year, e.g. "Entering in 2007"

          /* get all college names */
          x.domain(stackedData[0].values.map(function(d) {return d.x;}));
          y.domain([0, d3.max(stackedData,
              function(d){
                  return d3.max(d.values, function(e){
                      return +e.y0 + +e.y;
                  });
              })]).nice();

          var rearrangeRects = function(collegeObject){
              var indexOfCollege = stackedData.indexOf(collegeObject);
              /* remove from list, and append to front */
              stackedData.splice(indexOfCollege, 1);
              stackedData.unshift(collegeObject);
              /* restack the data after rearranging it */
              stackedData = stack(nested.find(yearData).values);  // TODO change this to be nested[selectedYear]
              layers.selectAll("rect")
                        .transition()
                        .duration(1000)
                        .delay(function(d,i){return i*25;})
                        .attr("y", function(d) {
                            return y(+d.y + +d.y0);
                        });
          };

          var layers = chart.selectAll(".layer")
                        .data(stackedData, function(d){
                            // get all regions
                            return d.key;
                        });

          layers.enter().append("g")
                        .attr("class", "layer")
                        .style("fill", function(d, i) {
                            return color(d.key);
                          });
          layers.selectAll("rect")
                        // for every ethnic_cat, get num_firstyears
                        .data(function(d) {
                          return d.values;
                        })
                    .enter().append("rect")
                        .attr("x", function(d) {return margin.left + x(d.x); })
                        .attr("y", function(d) {return y(+d.y + +d.y0); })
                        .attr("height", function(d) {
                            return y(+d.y0) - y(+d.y + +d.y0);
                        })
                        .attr("width", x.rangeBand() - 1)
                    .on("click", function(d){
                        /* get this rect's parentNode (i.e. its g) */
                        var collegeObject = d3.select(this.parentNode).datum();
                        rearrangeRects(collegeObject);
                    });

          chart.append("g")
                .attr("class", "axis")
                .attr("transform", "translate("+margin.left+","+height+")")
                .call(xAxis);

          chart.append("g")
                .attr("class", "axis")
                .attr("transform", "translate("+margin.left+",0)")
                .call(yAxis);


          printCollegeList = function(){
               var collegeList = d3.select("#collegeList");
               collegeList.selectAll(".collegeListElement").remove();

               stackedData.forEach(function(collegeObject){
                   collegeList.append("p")
                           .attr("class", "collegeListElement")
                           .text(collegeObject.key)
                           .style("color", function(d){
                               return color(collegeObject.key);
                           })
                           .on("click", function(d){
                               rearrangeRects(collegeObject);
                           });
               });
           };
           printCollegeList();

      };

    createVis.setYear = function(value){
        if (!arguments.length) {
          return yearData;
        }
        yearData = value;
        console.log("SET YEARDATA");
        console.log(yearData);
        return createVis;
      }

    var loadData = function(data){
      // var nested = d3.nest()
      //                .key(function(d){return d.year;})
      //                .key(function(d){return d.ethnic_cat;})
      //                .rollup(function(array){
      //                  return array.map(function(object){
      //                    return {
      //                      x: object.college,
      //                      y: +object.num_firstyears
      //                    };
      //                  });
      //                })
      //                .entries(data);
      //
      // console.log("HELLOOOOO nested");
      // console.log(nested);
      // createVis(data, nested);


      // var yearMenu = d3.select("#yearmetrics");
      // nested.forEach(function(obj){
      //   yearMenu.append("option").attr("value", obj.key).text(obj.key);
      // })
      // // for (prop in nested){
      // //   console.log("prop!!!!!!!!");
      // //   console.log(prop);
      // //   yearMenu.append("option").attr("value", prop).text(prop);
      // // }
      //
      // document.getElementById('yearSelect').value = "2005";
      //
      // d3.select("#yearSelect").on("change", function(){
      //   createVis.setYear(this.value);
      //   createVis(data, nested);
      // });
    }

    d3.csv("college_data.csv", createVis);

    </script>
  </body>
</html>
